Subject: backport of the CVE-2017-17969 fix from 7zip 18.00-beta
Forwarded: https://sourceforge.net/p/p7zip/bugs/204/
Bug-Debian: http://bugs.debian.org/888297
Author: Antoine Beaupr√© <anarcat@debian.org>
Applied-Upstream: 18.00-beta
Last-Update: 2018-01-26

diff -pruN '--exclude=*.orig' p7zip_16.02~/CPP/7zip/Compress/ShrinkDecoder.cpp p7zip_16.02/CPP/7zip/Compress/ShrinkDecoder.cpp
--- p7zip_16.02~/CPP/7zip/Compress/ShrinkDecoder.cpp	2016-05-18 17:31:02.000000000 +0000
+++ p7zip_16.02/CPP/7zip/Compress/ShrinkDecoder.cpp	2018-05-02 12:40:10.104831925 +0000
@@ -121,7 +121,12 @@ HRESULT CDecoder::CodeReal(ISequentialIn
     {
       _stack[i++] = _suffixes[cur];
       cur = _parents[cur];
+      if (cur >= kNumItems || i >= kNumItems)
+        break;
     }
+
+    if (cur >= kNumItems || i >= kNumItems)
+      break;
     
     _stack[i++] = (Byte)cur;
     lastChar2 = (Byte)cur;
